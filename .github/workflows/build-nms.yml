name: build-nms
on:
  workflow_call:
    inputs:
      groups-file:
        type: string
        default: .github/workflows/nms-groups.yml
      cache-key:
        type: string
        required: true

jobs:
  compile:
    runs-on: ubuntu-latest
    env:
      CACHE_KEY: ${{ inputs.cache-key }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - id: load-groups
        run: |
          python <<'PY'
          import yaml, json, os
          with open("${{ inputs.groups-file }}", encoding="utf-8") as f:
              groups = yaml.safe_load(f) or {}
          for key in ("java8","java16","java17","java21"):
              versions = ",".join(groups.get(key, []))
              print(f"{key}={versions}", file=open(os.environ['GITHUB_OUTPUT'], 'a'))
          PY

      - name: Restore aggregated Maven repo
        id: cache-restore
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          key: ${{ env.CACHE_KEY }}
          restore-keys: |
            nms-cache-
          path: |
            ~/.m2/repository/org/spigotmc/spigot

      - name: Build Java 8 NMS
        if: ${{ steps.load-groups.outputs.java8 != '' }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: 8
      - if: ${{ steps.load-groups.outputs.java8 != '' }}
        uses: SpraxDev/Action-SpigotMC@e63b635efcbaeb868bf21878c46f61b7d919a0ac # v5.2.0
        with:
          versions: ${{ steps.load-groups.outputs.java8 }}

      - name: Build Java 16 NMS
        if: ${{ steps.load-groups.outputs.java16 != '' }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: 16
      - if: ${{ steps.load-groups.outputs.java16 != '' }}
        uses: SpraxDev/Action-SpigotMC@e63b635efcbaeb868bf21878c46f61b7d919a0ac # v5.2.0
        with:
          versions: ${{ steps.load-groups.outputs.java16 }}

      - name: Build Java 17 NMS
        if: ${{ steps.load-groups.outputs.java17 != '' }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: 17
      - if: ${{ steps.load-groups.outputs.java17 != '' }}
        uses: SpraxDev/Action-SpigotMC@e63b635efcbaeb868bf21878c46f61b7d919a0ac # v5.2.0
        with:
          versions: ${{ steps.load-groups.outputs.java17 }}

      - name: Build Java 21 NMS
        if: ${{ steps.load-groups.outputs.java21 != '' }}
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: temurin
          java-version: 21
      - if: ${{ steps.load-groups.outputs.java21 != '' }}
        uses: SpraxDev/Action-SpigotMC@e63b635efcbaeb868bf21878c46f61b7d919a0ac # v5.2.0
        with:
          versions: ${{ steps.load-groups.outputs.java21 }}

      - name: Save aggregated Maven repo
        if: ${{ always() }}
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          key: ${{ env.CACHE_KEY }}
          path: |
            ~/.m2/repository/org/spigotmc/spigot
